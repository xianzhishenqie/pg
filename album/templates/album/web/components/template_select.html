
<style>
    #templateSelect {
        position: absolute;
        z-index: 10;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: #ffffff;
        display: none;
    }
    #templateSelect .weui-cells {
        overflow: auto;
    }
    #templateSelect .weui-cells:before {
        border-top: none;
    }
</style>

{% verbatim %}
<div id="templateSelect" v-cloak>
    <div class="weui-navbar" style="position: initial;">
        <div class="weui-navbar__item"
             style="padding: 5px 0;"
             :class="{'weui-bar__item_on text-danger border-bottom border-danger': templateTag.active}"
             :data-id="templateTag.id"
             @click="tagTemplateTag(templateTag)"
             v-for="templateTag in templateTags">
            {{ templateTag.name }}
        </div>
    </div>
    <div class="weui-cells mt-0">
        <span class="weui-cell weui-cell_access" @click="selectTemplate(template)" v-for="template, i in templates">
            <div class="weui-cell__hd"><img alt=""
                                            class="rounded-circle d-block"
                                            :src="template.cover_url || template.cover"
                                             style="width:50px;height:50px;margin-right:5px;"></div>
            <div class="weui-cell__bd weui-cell_primary">
                <p>{{ template.name }}</p>
            </div>
            <span class="weui-cell__ft"></span>
        </span>
    </div>
</div>
{% endverbatim %}

<script type="text/javascript">
    $.extend(context, {
        templateTagApiUrl: '{% url "album:web:api:template-tag-list" %}',
        templateApiUrl: '{% url "album:web:api:template-list" %}',

        selectTemplate: function (template) {},
    });

    $(function () {
        window.tVue = new Vue({
            el: '#templateSelect',
            data: {
                templateTags: [],
                templates: [],

                hotTemplateTag: {
                    id: '-1',
                    name: '热门',
                    active: true,
                },
                lastTemplateTag: {
                    id: '-2',
                    name: '最新',
                    active: false,
                },
                templateTag: null,
                search: '',
                template: null,
            },
            methods: {
                getTemplateTags: function () {
                    var vue = this;
                    http.get(context.templateTagApiUrl, {}, function (res) {
                        vue.hotTemplateTag.active = true;
                        vue.templateTags = [vue.hotTemplateTag, vue.lastTemplateTag].concat(res.rows);
                        vue.getTemplates();
                    });
                },
                tagTemplateTag: function(templateTag) {
                    var vue = this;
                    if (templateTag.active) {
                        return;
                    }

                    if (vue.templateTag) {
                        Vue.set(vue.templateTag, 'active', false);
                    }
                    Vue.set(templateTag, 'active', true);
                    vue.templateTag = templateTag;
                    vue.getTemplates();
                },
                getTemplates: function () {
                    var vue = this;
                    http.get(context.templateApiUrl, {
                        tag: vue.templateTag.id,
                        search: vue.search,
                    }, function (res) {
                        vue.templates = res.rows;
                        $.each(vue.templates, function (i, template) {
                            if (vue.template && vue.template.id == template.id) {
                                template.active = true;
                            }
                        });
                    });
                },
                clearSearch: function () {
                    this.search = '';
                    this.getTemplates();
                },
                fixListPanelHeight: function () {
                    var height = document.documentElement.clientHeight - $(this.$el).find('.weui-navbar').outerHeight();
                    $(this.$el).find('.weui-cells').height(height);
                },
                show: function () {
                    docUtil.setTitle('选择模板');
                    $(this.$el).animateCss('slideInRight').show();
                    this.fixListPanelHeight();
                },
                hide: function () {
                    docUtil.revertTitle();
                    $(this.$el).animateCss('slideOutRight', function ($el) {
                        $el.hide();
                    });
                },
                selectTemplate: function (template) {
                    this.hide();
                    context.selectTemplate(template);
                },
            },
            mounted: function () {
                var vue = this;
                vue.templateTag = vue.hotTemplateTag;
                vue.getTemplateTags();
            }
        });
    });
</script>