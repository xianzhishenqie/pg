{% extends './base.html' %}

{% load i18n %}
{% load staticfiles %}
{% load static_v %}

{% block title %}
{% endblock %}

{% block local_css %}
    <style>
        ul, p, label{
            margin-bottom: auto;
        }
    </style>
    <style>

    </style>
{% endblock %}

{% block container %}
    {% verbatim %}
    <div id="album" v-cloak>
        <p class="weui-cells__title">照片上传</p>
        <div class="weui-cells weui-cells_form" id="uploaderCustom">
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <div class="weui-uploader">
                        <div class="weui-uploader__hd d-none"><p class="weui-uploader__title">照片上传</p></div>
                        <div class="weui-uploader__bd">
                            <ul class="weui-uploader__files" id="uploaderCustomFiles">
                                <li class="weui-uploader__file"
                                    :data-seq="picture.seq"
                                    :style="'background-image: url(' + picture.image + ');'"
                                    @click="displayPicture(picture)"
                                    v-for="picture in album.picture_list"></li>

                            </ul>
                            <div class="weui-uploader__input-box"><input id="uploaderCustomInput"
                                                                         class="weui-uploader__input" type="file"
                                                                         accept="image/*" multiple=""></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="weui-panel">
            <div class="weui-panel__hd">相册模板</div>
                <div class="weui-media-box weui-media-box_small-appmsg">
                    <div class="weui-cells">
                        <a class="weui-cell weui-cell_access" href="javascript:;">
                            <div class="weui-cell__hd"><img src="" alt="" style="width:20px;margin-right:5px;display:block"></div>
                            <div class="weui-cell__bd weui-cell_primary">
                                <p>文字标题</p>
                            </div>
                            <span class="weui-cell__ft"></span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="weui-panel">
            <div class="weui-panel__hd">相册音乐</div>
            <div class="weui-panel__bd">
                <div class="weui-media-box weui-media-box_small-appmsg">
                    <div class="weui-cells">
                        <a class="weui-cell weui-cell_access" href="javascript:;">
                            <div class="weui-cell__hd"><img src="" alt="" style="width:20px;margin-right:5px;display:block"></div>
                            <div class="weui-cell__bd weui-cell_primary">
                                <p>文字标题</p>
                            </div>
                            <span class="weui-cell__ft"></span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="musicSelect" v-cloak>
        <div class="weui-navbar" style="position: initial;">
            <div class="weui-navbar__item"
                 :class="{'weui-bar__item_on': musicTag.active}"
                 :data-id="musicTag.id"
                 @click="tagMusicTag(musicTag)"
                 v-for="musicTag in musicTags">
                {{ musicTag.name }}
            </div>
        </div>
        <div class="weui-search-bar" id="searchBar">
            <div class="weui-search-bar__form">
                <div class="weui-search-bar__box">
                    <i class="weui-icon-search"></i>
                    <input type="search" class="weui-search-bar__input" placeholder="搜索" required=""
                           @change="getMusics"
                           v-model="search">
                    <a href="javascript:" class="weui-icon-clear" @click="clearSearch"></a>
                </div>
                <label class="weui-search-bar__label">
                    <i class="weui-icon-search"></i>
                    <span>搜索</span>
                </label>
            </div>
            <a href="javascript:" class="weui-search-bar__cancel-btn" @click="clearSearch">取消</a>
        </div>
        <div class="weui-panel__bd">
            <div class="weui-media-box weui-media-box_small-appmsg">
                <div class="weui-cells">
                    <a class="weui-cell weui-cell_access" href="javascript:;" v-for="music, i in musics">
                        <div class="weui-cell__hd"><i class="fa fa-music" style="width:20px;margin-right:5px;display:block"></i></div>
                        <div class="weui-cell__bd weui-cell_primary">
                            <p>{{ music.name }}</p>
                        </div>
                        <span class="fa fa-play-circle-o"
                              :class="{'fa-pause-circle-o': music.active}"
                              @click="playMusic(i, music)"></span>
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endverbatim %}
{% endblock %}



{% block bottom_js %}
    {{ block.super }}
{% endblock %}
{% block local_js %}
<script type="text/javascript">
    var context = {
        pk: {{ pk }},
        albumDetailApiUrl: '{% url "album:web:api:album-detail" pk %}',
        albumPictureApiUrl: '{% url "album:web:api:album-picture" pk %}',
        musicTagApiUrl: '{% url "album:web:api:music-tag-list" %}',
        musicApiUrl: '{% url "album:web:api:music-list" %}',
    }
</script>
<script type="text/javascript">
var aVue = new Vue({
    el: '#album',
    data: {
        album: {
            name: '',
            desc: '',
            picture_list: [],
        },

        pictureSeq: 0,
    },
    methods: {
        getAlbum: function () {
            var vue = this;
            http.get(context.albumDetailApiUrl, {}, function(res){
                vue.album = res;
                vue.getPictureSeq();
            });
        },
        getPictureSeq: function () {
            var vue = this;
            $.each(vue.album.picture_list, function (i, picture) {
                if (vue.pictureSeq < picture.seq) {
                    vue.pictureSeq = picture.seq;
                }
            });
        },
        displayPicture: function (picture) {
            var vue = this;
            var gallery = weui.gallery(picture.image, {
                onDelete: function(){
                    if(confirm('确定删除该图片？')){
                        http.delete(context.albumPictureApiUrl, {
                            picture__id: picture.id,
                        }, function () {
                            var pictureList = vue.album.picture_list;
                            pictureList.splice(pictureList.indexOf(picture), 1);
                        })
                    }
                    gallery.hide();
                }
            });
        },
    },
    mounted: function () {
        var vue = this;

        vue.getAlbum();

        weui.uploader('#uploaderCustom', {
            url: context.albumPictureApiUrl,
            auto: true,
            type: 'file',
            fileVal: 'picture__image',
            compress: {
                width: 1600,
                height: 1600,
                quality: .8
            },
            onBeforeQueued: function(files) {
                // `this` 是轮询到的文件, `files` 是所有文件

                if (["image/jpg", "image/jpeg", "image/png", "image/gif"].indexOf(this.type) < 0) {
                    weui.alert('请上传图片');
                    return false; // 阻止文件添加
                }
                if (this.size > 10 * 1024 * 1024) {
                    weui.alert('请上传不超过10M的图片');
                    return false;
                }
                if (files.length > 9) { // 防止一下子选择过多文件
                    weui.alert('每次最多只能上传9张图片，请重新选择');
                    return false;
                }

                // return true; // 阻止默认行为，不插入预览图的框架
            },
            onQueued: function(){
                console.log(this);

                // console.log(this.status); // 文件的状态：'ready', 'progress', 'success', 'fail'
                // console.log(this.base64); // 如果是base64上传，file.base64可以获得文件的base64

                // this.upload(); // 如果是手动上传，这里可以通过调用upload来实现；也可以用它来实现重传。
                // this.stop(); // 中断上传

                // return true; // 阻止默认行为，不显示预览图的图像
            },
            onBeforeSend: function(data, headers){
                console.log(this, data, headers);
                $.extend(data, {picture__seq: vue.pictureSeq + this.id}); // 可以扩展此对象来控制上传参数
                $.extend(headers, {'X-CSRFToken': csrftoken}); // 可以扩展此对象来控制上传头部
                // return false; // 阻止文件上传
            },
            onProgress: function(procent){
                console.log(this, procent);
                // return true; // 阻止默认行为，不使用默认的进度显示
            },
            onSuccess: function (ret) {
                console.log(this, ret);
                $('#uploaderCustomFiles li[data-id=' + this.id + ']').remove();
                vue.album.picture_list.push(ret);
                vue.album.picture_list.sort(function (a, b) {
                    if (a.seq < b.seq) {
                        return -1;
                    } else {
                        return 1;
                    }
                });
                // return true; // 阻止默认行为，不使用默认的成功态
            },
            onError: function(err){
                console.log(this, err);
                // return true; // 阻止默认行为，不使用默认的失败态
            }
        });
    }

});
</script>

<script type="text/javascript">
var mVue = new Vue({
    el: '#musicSelect',
    data: {
        musicTags: [],
        musics: [],

        allMuiscTag: {
            id: '',
            name: '全部',
            active: true,
        },
        musicTag: null,
        search: '',
        music: null,
    },
    methods: {
        getMusicTags: function () {
            var vue = this;
            http.get(context.musicTagApiUrl, {}, function (res) {
                vue.allMuiscTag.active = true;
                vue.musicTags = [vue.allMuiscTag].concat(res);
                vue.getMusics();
            });
        },
        tagMusicTag: function(musicTag) {
            var vue = this;
            if (musicTag.active) {
                return;
            }

            if (vue.musicTag) {
                Vue.set(vue.musicTag, 'active', false);
            }
            Vue.set(musicTag, 'active', true);
            vue.musicTag = musicTag;
            vue.getMusics();
        },
        getMusics: function () {
            var vue = this;
            http.get(context.musicApiUrl, {
                tag: vue.musicTag.id,
                search: vue.search,
            }, function (res) {
                vue.musics = res;
                $.each(vue.musics, function (i, music) {
                    if (vue.music && vue.music.id == music.id) {
                        music.active = true;
                    }
                });
            });
        },
        clearSearch: function () {
            this.search = '';
        },
        playMusic: function (i, music) {
            var vue = this;
            if (music.active) {
                Vue.set(music, 'active', false)
                return;
            }

            if (vue.music) {
                Vue.set(vue.music, 'active', false);
            }
            Vue.set(music, 'active', true);
            Vue.set(vue.musics, i, music);
            vue.music = music;
        }
    },
    mounted: function () {
        weui.searchBar('#searchBar');

        var vue = this;
        vue.musicTag = vue.allMuiscTag;
        vue.getMusicTags();
    }
});
</script>
{% endblock %}